<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Настройка</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Onest:wght@100..900&display=swap" rel="stylesheet">
    
    <style>
        /* === ГЛОБАЛЬНЫЕ СТИЛИ === */
        :root {
            --primary: #00D68F;
            --bg: #010101;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            margin: 0; padding: 0; width: 100%; height: 100vh;
            font-family: 'Onest', sans-serif;
            background-color: var(--bg);
            color: #fff;
            overflow: hidden;
            position: relative;
        }

        .fixed-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
            background: #010101 url('bg.png') no-repeat top center; background-size: cover;
            pointer-events: none;
        }

        .App { width: 100%; height: 100%; display: flex; justify-content: center; padding: 15px; max-width: 500px; margin: 0 auto; }
        .SetupPage { width: 100%; height: 100%; display: flex; flex-direction: column; padding-top: 60px; padding-bottom: 20px; }
        .SetupPage__top { position: relative; flex: 1; display: flex; justify-content: center; align-items: center; }

        /* === КОЛЬЦА (Rings) === */
        .SetupPage__rings { position: absolute; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; pointer-events: none; }
        .SetupPage__rings div { position: absolute; border-radius: 50%; border: 1px solid rgba(255, 255, 255, 0.05); }
        .ring-1 { width: 160px; height: 160px; }
        .ring-2 { width: 240px; height: 240px; opacity: 0.6; }
        .ring-3 { width: 320px; height: 320px; opacity: 0.3; }

        /* === ПРОГРЕСС БАР (FIXED 32x32 ViewBox как в оригинале) === */
        .SetupPage__progress { 
            position: relative; 
            width: 80px; height: 80px; /* Визуальный размер */
            display: flex; align-items: center; justify-content: center; 
        }
        .SetupPage__progress svg { 
            width: 100%; height: 100%; 
            transform: rotate(-90deg); 
        }
        
        /* Фон круга (stroke-width 0.2 как в коде) */
        .progress-bg { 
            fill: none; 
            stroke: rgba(255,255,255,0.1); 
            stroke-width: 1px; /* Чуть толще 0.2, чтобы было видно на темном */
        }
        
        /* Заполнение (stroke-width побольше для акцента) */
        .progress-fill {
            fill: none; 
            stroke: #00D68F; 
            stroke-width: 1.5px; /* Аккуратная тонкая линия */
            stroke-linecap: round;
            /* Длина окружности 2*PI*15.8 ≈ 99.27 */
            stroke-dasharray: 99.27; 
            stroke-dashoffset: 99.27; /* Пустой */
            transition: stroke-dashoffset 0.8s ease-in-out;
        }
        
        /* Иконка в центре */
        .SetupPage__icon { position: absolute; color: #fff; display: flex; align-items: center; justify-content: center; }
        .SetupPage__icon svg { width: 42px; height: 42px; }

        /* === ТЕКСТЫ === */
        .SetupPage__bottom { width: 100%; display: flex; flex-direction: column; align-items: center; text-align: center; margin-top: auto; }
        .text-title { font-size: 20px; font-weight: 600; color: #ffffff; margin: 0; }
        .text-subtitle { font-size: 14px; color: #9ca3af; margin-top: 8px; margin-bottom: 24px; line-height: 1.4; }

        /* ========================================= */
        /* === КНОПКИ (1-в-1 ORIGINAL) === */
        /* ========================================= */

        .Buttons-Container {
            display: flex; flex-direction: column; width: 100%;
            gap: 16px; 
        }

        .Buttons-Row { 
            display: flex; width: 100%; 
            gap: 10px; /* gap-2.5 = 10px */
        }

        .Button-Original {
            width: 100%; height: 54px; /* h-54 */
            border-radius: 16px; /* rounded-large */
            font-family: 'Onest', sans-serif;
            font-size: 14px; /* text-sm */
            font-weight: 500; /* font-normal */
            display: flex; align-items: center; justify-content: center;
            border: none; cursor: pointer;
            position: relative; z-index: 1;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 0; 
            white-space: nowrap; /* whitespace-nowrap */
        }

        .Button-Original:active { transform: scale(0.97); }

        /* --- 1. PRIMARY (Зеленая) --- */
        .Button--primary {
            background: #00D68F; /* bg-primary */
            color: #ffffff; /* text-primary-foreground */
            gap: 8px; /* gap-2 */
        }

        /* Pulsed Animation (Тень-радар) */
        .Button--pulsed { animation: shadow-pulse 2s infinite; }
        @keyframes shadow-pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 214, 143, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 214, 143, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 214, 143, 0); }
        }

        /* --- 2. SECONDARY (Полупрозрачная) --- */
        .Button--secondary {
            background-color: rgba(0, 214, 143, 0.2); /* bg-primary/20 */
            color: #ffffff;
        }
        .Button--secondary:active { background-color: rgba(0, 214, 143, 0.3); }

        /* --- 3. LIGHTED (Далее) --- */
        .Button--variant_lighted {
            background: transparent;
            /* border-primary-50 (50% opacity) */
            border: 1px solid rgba(0, 214, 143, 0.5); 
            color: #ffffff;
            gap: 28px; /* gap-7 */
        }
        /* Смещение стрелки (-mr-4) */
        .Button--variant_lighted svg { margin-right: -16px; width: 20px; height: 20px; }

    </style>
</head>
<body class="ultima">
    <div class="fixed-background"></div>

    <div class="App">
        <div class="SetupPage">
            
            <div class="SetupPage__top">
                <div class="SetupPage__rings">
                    <div class="ring-1"></div>
                    <div class="ring-2"></div>
                    <div class="ring-3"></div>
                </div>
                
                <div class="SetupPage__progress">
                    <svg viewBox="0 0 32 32">
                        <circle cx="16" cy="16" r="15.8" class="progress-bg"></circle>
                        <circle cx="16" cy="16" r="15.8" class="progress-fill" id="progress-circle"></circle>
                    </svg>
                    
                    <div class="SetupPage__icon" id="status-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"><path d="m19 5 3-3"></path><path d="m2 22 3-3"></path><path d="M6.3 20.3a2.4 2.4 0 0 0 3.4 0L12 18l-6-6-2.3 2.3a2.4 2.4 0 0 0 0 3.4Z"></path><path d="M7.5 13.5 10 11"></path><path d="M10.5 16.5 13 14"></path><path d="m12 6 6 6 2.3-2.3a2.4 2.4 0 0 0 0-3.4l-2.6-2.6a2.4 2.4 0 0 0-3.4 0Z"></path></svg>
                    </div>
                </div>
            </div>

            <div class="SetupPage__bottom">
                <p class="text-title" id="setup-title">Настройка устройства</p>
                <p class="text-subtitle" id="setup-subtitle">
                    Настройка VPN происходит <br>в 3 шага и занимает пару минут
                </p>

                <div id="initial-buttons" class="Buttons-Container">
                    <button class="Button-Original Button--primary Button--pulsed" id="start-btn" onclick="startProcess()">
                        <span id="btn-start-text">Начать настройку</span>
                    </button>

                    <button class="Button-Original Button--secondary" onclick="openManual()">
                        Установить на другом устройстве
                    </button>
                </div>

                <div id="step-buttons-container" class="Buttons-Row" style="display: none;">
                    
                    <button class="Button-Original Button--primary Button--pulsed" onclick="performInstall()">
                        Установить
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 13v8l-4-4"></path><path d="m12 21 4-4"></path><path d="M4.393 15.269A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.436 8.284"></path></svg>
                    </button>

                    <button class="Button-Original Button--variant_lighted" onclick="nextStep()">
                        Далее
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="m12 5 7 7-7 7"></path></svg>
                    </button>
                </div>
                
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.BackButton.show();
        tg.BackButton.onClick(() => {
            window.location.href = 'index.html' + window.location.search;
        });

        const urlParams = new URLSearchParams(window.location.search);
        const getParam = (key) => (urlParams.get(key) ? decodeURIComponent(urlParams.get(key)) : '');
        const vpnKey = getParam('vpn_key');

        const LINKS = {
            ios: getParam('link_ios'),
            android: getParam('link_android'),
            windows: getParam('link_windows'),
            macos: getParam('link_macos'),
            manual: getParam('link_manual')
        };

        const platform = tg.platform || 'unknown';
        let deviceName = 'устройстве';
        let appName = 'Приложение';
        let installLink = LINKS.manual;

        function initPage() {
            if (['ios', 'ipad', 'iphone'].includes(platform)) {
                deviceName = 'iOS'; appName = 'V2RayTun'; installLink = LINKS.ios;
            } else if (platform === 'android') {
                deviceName = 'Android'; appName = 'V2RayTun'; installLink = LINKS.android;
            } else if (['tdesktop', 'weba'].includes(platform) && navigator.userAgent.indexOf('Win') !== -1) {
                deviceName = 'Windows'; appName = 'Hiddify'; installLink = LINKS.windows;
            } else if (platform === 'macos') {
                deviceName = 'macOS'; appName = 'V2RayTun'; installLink = LINKS.macos;
            }

            document.getElementById('setup-title').innerText = `Настройка на ${deviceName}`;
            document.getElementById('btn-start-text').innerText = `Начать настройку на ${deviceName}`;
        }

        // Иконка Cloud Download (с stroke-width 1.25 как в оригинале)
        const ICON_CLOUD = `<svg xmlns="http://www.w3.org/2000/svg" width="84" height="84" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"><path d="M12 13v8l-4-4"></path><path d="m12 21 4-4"></path><path d="M4.393 15.269A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.436 8.284"></path></svg>`;

        function startProcess() {
            if (!vpnKey) {
                tg.showAlert("Сначала купите подписку!");
                return;
            }
            
            tg.HapticFeedback.impactOccurred('medium');

            // 33% (остаток 66.5 от 99.27)
            document.getElementById('progress-circle').style.strokeDashoffset = '66.5'; 
            document.getElementById('status-icon').innerHTML = ICON_CLOUD;
            
            document.getElementById('setup-title').innerText = "Приложение";
            document.getElementById('setup-subtitle').innerHTML = `Установите приложение ${appName} <br>и вернитесь к этому экрану`;

            // Смена кнопок
            document.getElementById('initial-buttons').style.display = 'none';
            document.getElementById('step-buttons-container').style.display = 'flex';
        }

        function performInstall() {
            tg.HapticFeedback.impactOccurred('light');
            if (installLink) tg.openLink(installLink);
            else tg.showAlert("Ссылка не найдена");
        }

        function nextStep() {
            tg.HapticFeedback.impactOccurred('light');
            tg.showAlert("Переход к шагу 2...");
        }

        function openManual() { if(LINKS.manual) tg.openLink(LINKS.manual); }

        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
