<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Настройка</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Onest:wght@100..900&display=swap" rel="stylesheet">
    
    <style>
        /* === ГЛОБАЛЬНЫЕ СТИЛИ === */
        :root {
            --primary: #00D68F;
            --bg: #010101;
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            outline: none; 
            margin: 0;
            padding: 0;
        }

        body {
            width: 100%; 
            height: 100vh;
            font-family: 'Onest', sans-serif;
            background-color: var(--bg);
            color: #fff;
            overflow: hidden;
            position: fixed;
            display: flex;
            flex-direction: column;
        }

        .App { 
            flex: 1;
            display: flex; 
            justify-content: center; 
            padding: 16px; 
            max-width: 500px; 
            margin: 0 auto;
            width: 100%;
        }
        
        /* === ОСНОВНАЯ СТРУКТУРА КАК В ОРИГИНАЛЕ === */
        .SetupPage { 
            width: 100%; 
            flex: 1;
            display: flex; 
            flex-direction: column; 
            align-items: center;
            justify-content: space-between;
            padding-top: 40px;
        }

        /* Верхняя часть - кольца и прогресс */
        .SetupPage__top { 
            position: relative; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            width: 100%;
            height: 50vh;
            min-height: 300px;
            flex-shrink: 0;
        }

        /* === КОЛЬЦА ТОЧНО КАК В ОРИГИНАЛЕ === */
        .SetupPage__rings { 
            position: absolute; 
            width: 100%;
            height: 100%;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            pointer-events: none; 
        }
        
        .SetupPage__rings div { 
            position: absolute; 
            border-radius: 50%; 
            border: 1px solid rgba(255, 255, 255, 0.05);
            animation: ringPulse 4s ease-in-out infinite;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        /* Размеры и прозрачность как в оригинале */
        .ring-1 { 
            width: 180px; 
            height: 180px; 
            border-color: rgba(255, 255, 255, 0.05);
            animation-delay: 0s;
        }
        .ring-2 { 
            width: 260px; 
            height: 260px; 
            border-color: rgba(255, 255, 255, 0.08);
            animation-delay: 0.5s;
        }
        .ring-3 { 
            width: 340px; 
            height: 340px; 
            border-color: rgba(255, 255, 255, 0.12);
            animation-delay: 1s;
        }
        .ring-4 { 
            width: 420px; 
            height: 420px; 
            border-color: rgba(255, 255, 255, 0.15);
            animation-delay: 1.5s;
        }

        @keyframes ringPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.7; }
        }

        /* === ПРОГРЕСС БАР - ТОЧНАЯ КОПИЯ ОРИГИНАЛА === */
        .SetupPage__progress { 
            position: relative; 
            width: 100px; 
            height: 100px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 2;
        }
        
        .SetupPage__progress svg { 
            width: 100%; 
            height: 100%; 
            transform: rotate(-90deg);
        }
        
        .progress-bg { 
            fill: none; 
            stroke: transparent; 
            stroke-width: 0.2; 
        }
        
        .progress-fill {
            fill: none; 
            stroke: #00D68F;
            stroke-width: 0.2; 
            stroke-linecap: round;
            stroke-dasharray: 99.274; 
            stroke-dashoffset: 99.274; 
            transition: stroke-dashoffset 0.7s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* ИКОНКА В ЦЕНТРЕ */
        .SetupPage__icon { 
            position: absolute; 
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            width: 84px; 
            height: 84px;
            z-index: 3;
        }
        
        .SetupPage__icon svg { 
            width: 84px; 
            height: 84px; 
            color: #00D68F;
            filter: drop-shadow(0 0 10px rgba(0, 214, 143, 0.3));
        }

        /* === НИЖНЯЯ ЧАСТЬ С ТЕКСТОМ И КНОПКАМИ === */
        .SetupPage__bottom { 
            width: 100%; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            text-align: center; 
            padding-bottom: 40px;
            flex-shrink: 0;
        }

        /* Текст как в оригинале */
        .text-title { 
            font-size: 20px; 
            font-weight: 600; 
            color: #FFFFFF;
            margin: 0 0 8px 0;
            line-height: 1.2;
        }
        
        .text-subtitle { 
            font-size: 15px; 
            color: #9CA3AF; 
            margin: 0 0 32px 0; 
            line-height: 1.4; 
            font-weight: 400;
        }

        /* === КНОПКИ - ТОЧНАЯ КОПИЯ ОРИГИНАЛА === */
        .Buttons-Container { 
            display: flex; 
            flex-direction: column; 
            width: 100%; 
            gap: 12px; 
        }

        .Buttons-Row { 
            display: flex; 
            width: 100%; 
            gap: 12px; 
        }

        /* Базовый стиль кнопки как в оригинале */
        .Button-Original {
            width: 100%; 
            height: 54px;
            border-radius: 16px;
            font-family: 'Onest', sans-serif;
            font-size: 14px; 
            font-weight: 500;
            display: flex; 
            align-items: center; 
            justify-content: center;
            border: none; 
            cursor: pointer;
            position: relative; 
            z-index: 1;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 0; 
            white-space: nowrap;
            overflow: hidden;
            user-select: none;
        }
        
        .Button-Original:active { 
            transform: scale(0.97); 
        }
        
        /* Primary кнопка - основной акцент */
        .Button--primary {
            background-color: #00D68F; 
            color: #FFFFFF; 
        }
        
        /* Анимация пульсации как в оригинале */
        .Button--pulsed { 
            animation: shadowPulse 2s infinite; 
        }
        
        @keyframes shadowPulse {
            0% { 
                box-shadow: 0 0 0 0 rgba(0, 214, 143, 0.7); 
            }
            70% { 
                box-shadow: 0 0 0 10px rgba(0, 214, 143, 0); 
            }
            100% { 
                box-shadow: 0 0 0 0 rgba(0, 214, 143, 0); 
            }
        }
        
        /* Secondary кнопка - прозрачная */
        .Button--secondary {
            background-color: rgba(0, 214, 143, 0.2); 
            color: #FFFFFF;
        }
        
        .Button--secondary:active { 
            background-color: rgba(0, 214, 143, 0.3); 
        }

        /* Кнопка с иконкой */
        .Button--with-icon {
            gap: 8px;
        }
        
        .Button--with-icon svg { 
            width: 20px; 
            height: 20px; 
        }

        /* === МЕДИА-ЗАПРОСЫ ДЛЯ АДАПТИВНОСТИ === */
        @media (max-width: 480px) {
            .SetupPage {
                padding-top: 20px;
            }
            
            .SetupPage__top {
                height: 45vh;
                min-height: 250px;
            }
            
            .ring-1 { width: 150px; height: 150px; }
            .ring-2 { width: 220px; height: 220px; }
            .ring-3 { width: 290px; height: 290px; }
            .ring-4 { width: 360px; height: 360px; }
            
            .SetupPage__progress {
                width: 80px;
                height: 80px;
            }
            
            .SetupPage__icon {
                width: 64px;
                height: 64px;
            }
            
            .SetupPage__icon svg {
                width: 64px;
                height: 64px;
            }
            
            .text-title {
                font-size: 18px;
            }
            
            .text-subtitle {
                font-size: 14px;
            }
        }

        @media (max-height: 700px) {
            .SetupPage__top {
                height: 40vh;
            }
            
            .SetupPage__bottom {
                padding-bottom: 20px;
            }
        }

        /* === ЭФФЕКТЫ ПРИ НАВЕДЕНИИ (ДЛЯ ДЕСКТОПА) === */
        @media (hover: hover) {
            .Button--primary:hover {
                background-color: #00E69A;
            }
            
            .Button--secondary:hover {
                background-color: rgba(0, 214, 143, 0.25);
            }
        }

    </style>
</head>
<body class="ultima">
    <div class="App">
        <div class="SetupPage">
            
            <!-- Верхняя часть с кольцами и прогрессом -->
            <div class="SetupPage__top">
                <div class="SetupPage__rings">
                    <div class="ring-1"></div>
                    <div class="ring-2"></div>
                    <div class="ring-3"></div>
                    <div class="ring-4"></div>
                </div>
                
                <!-- Прогресс круг -->
                <div class="SetupPage__progress">
                    <svg viewBox="0 0 32 32">
                        <circle cx="16" cy="16" r="15.8" class="progress-bg"></circle>
                        <circle cx="16" cy="16" r="15.8" class="progress-fill" id="progress-circle"></circle>
                    </svg>
                    
                    <!-- Иконка в центре -->
                    <div class="SetupPage__icon" id="status-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round">
                            <path d="m19 5 3-3"></path>
                            <path d="m2 22 3-3"></path>
                            <path d="M6.3 20.3a2.4 2.4 0 0 0 3.4 0L12 18l-6-6-2.3 2.3a2.4 2.4 0 0 0 0 3.4Z"></path>
                            <path d="M7.5 13.5 10 11"></path>
                            <path d="M10.5 16.5 13 14"></path>
                            <path d="m12 6 6 6 2.3-2.3a2.4 2.4 0 0 0 0-3.4l-2.6-2.6a2.4 2.4 0 0 0-3.4 0Z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Нижняя часть с текстом и кнопками -->
            <div class="SetupPage__bottom">
                <p class="text-title" id="setup-title">Настройка устройства</p>
                <p class="text-subtitle" id="setup-subtitle">
                    Настройка VPN происходит <br>в 3 шага и занимает пару минут
                </p>

                <!-- Начальные кнопки -->
                <div id="initial-buttons" class="Buttons-Container">
                    <button class="Button-Original Button--primary Button--pulsed" id="start-btn" onclick="startProcess()">
                        <span id="btn-start-text">Начать настройку</span>
                    </button>

                    <button class="Button-Original Button--secondary" onclick="openManual()">
                        Установить на другом устройстве
                    </button>
                </div>

                <!-- Кнопки для шагов (скрыты изначально) -->
                <div id="step-buttons-container" class="Buttons-Row" style="display: none;">
                    <button class="Button-Original Button--primary Button--pulsed Button--with-icon" onclick="performInstall()">
                        Установить
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 13v8l-4-4"></path>
                            <path d="m12 21 4-4"></path>
                            <path d="M4.393 15.269A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.436 8.284"></path>
                        </svg>
                    </button>

                    <button class="Button-Original Button--with-icon" onclick="nextStep()" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);">
                        Далее
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M5 12h14"></path>
                            <path d="m12 5 7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Инициализация Telegram WebApp
        const tg = window.Telegram.WebApp;
        
        // Расширяем на весь экран
        tg.expand();
        
        // Настройка кнопки "Назад"
        tg.BackButton.show();
        tg.BackButton.onClick(() => { 
            window.location.href = 'index.html' + window.location.search; 
        });

        // Получение параметров из URL
        const urlParams = new URLSearchParams(window.location.search);
        const getParam = (key) => {
            return urlParams.get(key) ? decodeURIComponent(urlParams.get(key)) : '';
        };
        
        const vpnKey = getParam('vpn_key');
        
        // Ссылки из параметров
        const LINKS = {
            ios: getParam('link_ios'),
            android: getParam('link_android'),
            windows: getParam('link_windows'),
            macos: getParam('link_macos'),
            manual: getParam('link_manual')
        };

        // Определение платформы
        const platform = tg.platform || 'unknown';
        let deviceName = 'устройстве';
        let appName = 'Приложение';
        let installLink = LINKS.manual;
        let step = 1;

        // Инициализация страницы
        function initPage() {
            // Определяем устройство и настройки
            if (['ios', 'ipad', 'iphone'].includes(platform)) {
                deviceName = 'iOS';
                appName = 'V2RayTun';
                installLink = LINKS.ios;
            } else if (platform === 'android') {
                deviceName = 'Android';
                appName = 'V2RayTun';
                installLink = LINKS.android;
            } else if (['tdesktop', 'weba'].includes(platform) && navigator.userAgent.indexOf('Win') !== -1) {
                deviceName = 'Windows';
                appName = 'Hiddify';
                installLink = LINKS.windows;
            } else if (platform === 'macos') {
                deviceName = 'macOS';
                appName = 'V2RayTun';
                installLink = LINKS.macos;
            }

            // Обновляем текст на странице
            document.getElementById('setup-title').textContent = `Настройка на ${deviceName}`;
            document.getElementById('btn-start-text').textContent = `Начать настройку на ${deviceName}`;
        }

        // SVG иконки
        const ICON_CLOUD = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 13v8l-4-4"></path>
                <path d="m12 21 4-4"></path>
                <path d="M4.393 15.269A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.436 8.284"></path>
            </svg>
        `;

        const ICON_CHECK = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
        `;

        const ICON_PLUG = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 22v-5"></path>
                <path d="M9 8V2"></path>
                <path d="M15 8V2"></path>
                <path d="M18 8v5a4 4 0 0 1-4 4h-4a4 4 0 0 1-4-4V8Z"></path>
            </svg>
        `;

        // Запуск процесса настройки
        function startProcess() {
            // Проверяем наличие ключа
            if (!vpnKey) {
                tg.showAlert("Сначала купите подписку!");
                tg.HapticFeedback.impactOccurred('heavy');
                return;
            }

            // Тактильный отклик
            tg.HapticFeedback.impactOccurred('medium');

            // Шаг 1: Установка приложения
            step = 1;
            updateProgress(33); // 33% - шаг 1
            updateUIForStep(step);
        }

        // Обновление прогресса
        function updateProgress(percent) {
            const progressCircle = document.getElementById('progress-circle');
            const circumference = 99.274;
            const offset = circumference - (percent / 100) * circumference;
            
            progressCircle.style.strokeDashoffset = offset;
        }

        // Обновление интерфейса для текущего шага
        function updateUIForStep(stepNumber) {
            const title = document.getElementById('setup-title');
            const subtitle = document.getElementById('setup-subtitle');
            const statusIcon = document.getElementById('status-icon');
            const initialButtons = document.getElementById('initial-buttons');
            const stepButtons = document.getElementById('step-buttons-container');

            switch(stepNumber) {
                case 1:
                    // Шаг 1: Установка приложения
                    title.textContent = "Приложение";
                    subtitle.innerHTML = `Установите приложение ${appName}<br>и вернитесь к этому экрану`;
                    statusIcon.innerHTML = ICON_CLOUD;
                    initialButtons.style.display = 'none';
                    stepButtons.style.display = 'flex';
                    break;
                    
                case 2:
                    // Шаг 2: Настройка подключения
                    updateProgress(66);
                    title.textContent = "Подключение";
                    subtitle.innerHTML = `Подключитесь к VPN серверу<br>через приложение ${appName}`;
                    statusIcon.innerHTML = ICON_PLUG;
                    break;
                    
                case 3:
                    // Шаг 3: Завершение
                    updateProgress(100);
                    title.textContent = "Готово!";
                    subtitle.innerHTML = `VPN успешно настроен<br>на вашем устройстве`;
                    statusIcon.innerHTML = ICON_CHECK;
                    stepButtons.style.display = 'none';
                    
                    // Показываем сообщение об успехе
                    setTimeout(() => {
                        tg.showAlert("Настройка успешно завершена!");
                        tg.HapticFeedback.notificationOccurred('success');
                    }, 300);
                    break;
            }
        }

        // Установка приложения
        function performInstall() {
            tg.HapticFeedback.impactOccurred('light');
            
            if (installLink) {
                // Открываем ссылку на установку
                tg.openLink(installLink);
                
                // Показываем подсказку
                tg.showAlert(`Открыта ссылка для установки ${appName}. После установки вернитесь в это окно и нажмите "Далее".`);
            } else {
                tg.showAlert("Ссылка для установки не найдена");
            }
        }

        // Переход к следующему шагу
        function nextStep() {
            tg.HapticFeedback.impactOccurred('light');
            
            if (step < 3) {
                step++;
                updateUIForStep(step);
            }
        }

        // Открытие мануала для другого устройства
        function openManual() {
            if (LINKS.manual) {
                tg.openLink(LINKS.manual);
            } else {
                tg.showAlert("Инструкция не найдена");
            }
        }

        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', initPage);

        // Дополнительные настройки
        setTimeout(() => {
            // Настройка анимации прогресса
            const progressCircle = document.getElementById('progress-circle');
            progressCircle.style.transition = 'stroke-dashoffset 0.7s ease-in-out';
            
            // Установка начального прогресса
            updateProgress(0);
        }, 100);

        // Обработка нажатий вне кнопок (для тестирования)
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.Button-Original')) {
                // Можно добавить дополнительные обработчики
            }
        });

    </script>
</body>
</html>
